<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ambulance Tracking Â· Crimson Shield</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: linear-gradient(135deg, #0b1219 0%, #151f2c 100%);
      color:#e2e8f0;
      display:flex;
      min-height:100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* --- ANIMATION (pin + pulse) - REPOSITIONED NEXT TO HEADING --- */
    .header-animation {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 15px;
      width: 50px;
      height: 50px;
      pointer-events: none;
      z-index: 15;
      transform: scale(0.9); /* Slightly smaller to fit better */
    }

    .pin {
      width: 30px;
      height: 30px;
      border-radius: 50% 50% 50% 0;
      background: #dc2626;
      position: absolute;
      transform: rotate(-45deg);
      left: 10px; /* Position within the container */
      top: 5px;
      box-shadow: 0 0 20px rgba(220,38,38,0.6);
      animation-name: bounce;
      animation-fill-mode: both;
      animation-duration: 1s;
    }

    .pin:after {
      content: '';
      width: 14px;
      height: 14px;
      margin: 8px 0 0 8px;
      background: #0b1219;
      position: absolute;
      border-radius: 50%;
    }

    .pulse {
      background: rgba(220,38,38,0.2);
      border-radius: 50%;
      height: 14px;
      width: 14px;
      position: absolute;
      left: 18px;
      top: 13px;
      transform: rotateX(55deg);
      z-index: -2;
    }

    .pulse:after {
      content: "";
      border-radius: 50%;
      height: 40px;
      width: 40px;
      position: absolute;
      margin: -13px 0 0 -13px;
      animation: pulsate 1s ease-out infinite;
      opacity: 0.0;
      box-shadow: 0 0 1px 2px #dc2626;
      animation-delay: 1.1s;
    }

    @keyframes pulsate {
      0% { transform: scale(0.1, 0.1); opacity: 0.0; }
      50% { opacity: 1.0; }
      100% { transform: scale(1.2, 1.2); opacity: 0; }
    }

    @keyframes bounce {
      0% { opacity: 0; transform: translateY(-200px) rotate(-45deg); }
      60% { opacity: 1; transform: translateY(10px) rotate(-45deg); }
      80% { transform: translateY(-5px) rotate(-45deg); }
      100% { transform: translateY(0) rotate(-45deg); }
    }

    /* --- SIDEBAR (higher z-index) --- */
    .sidebar {
      width:260px;
      background:rgba(18,25,35,0.95);
      border-right:1px solid rgba(220,38,38,0.2);
      padding:2rem 1.5rem;
      display:flex;
      flex-direction:column;
      position: relative;
      z-index: 10;
    }

    .logo {
      font-size:1.6rem;
      font-weight:800;
      margin-bottom:3rem;
    }
    .logo span { color:#dc2626; }

    .nav button {
      width:100%;
      padding:1rem;
      margin-bottom:1rem;
      border:none;
      border-radius:15px;
      background:transparent;
      color:#94a3b8;
      text-align:left;
      cursor:pointer;
      transition:0.3s;
    }

    .nav button:hover,
    .nav button.active {
      background:rgba(220,38,38,0.15);
      color:white;
    }

    .sidebar-footer{
      margin-top:auto;
    }

    .logout{
      background:#dc2626;
      border:none;
      padding:0.8rem;
      border-radius:15px;
      color:white;
      cursor:pointer;
      width:100%;
    }

    /* MAIN (higher z-index) */
    .main {
      flex:1;
      padding:2rem;
      position: relative;
      z-index: 10;
    }

    /* HEADER - with flex to accommodate animation */
    .header {
      display:flex;
      align-items:center;
      margin-bottom:2rem;
    }

    .header h1 {
      font-size:1.8rem;
      display: flex;
      align-items: center;
    }

    /* STATUS CARD */
    .status-card {
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(220,38,38,0.2);
      border-radius:20px;
      padding:2rem;
      margin-bottom:2rem;
      backdrop-filter: blur(2px);
    }

    .status-title {
      font-size:1.2rem;
      margin-bottom:1rem;
      color:white;
    }

    .status-live {
      color:#10b981;
      font-weight:600;
    }

    /* PROGRESS BAR */
    .progress-container {
      background:rgba(255,255,255,0.05);
      border-radius:20px;
      overflow:hidden;
      height:15px;
      margin:1rem 0;
    }

    .progress-bar {
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#dc2626,#b91c1c);
      transition:width 1s linear;
    }

    /* DRIVER INFO */
    .driver-card {
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(220,38,38,0.2);
      border-radius:20px;
      padding:1.5rem;
      margin-bottom:2rem;
      backdrop-filter: blur(2px);
    }

    .driver-card h3 {
      margin-bottom:0.5rem;
    }

    .btn {
      padding:0.6rem 1rem;
      border-radius:20px;
      border:none;
      cursor:pointer;
      font-size:0.85rem;
      font-weight:600;
      margin-right:0.5rem;
    }

    .btn-call {
      background:#10b981;
      color:#0b1219;
    }

    .btn-cancel {
      background:#ef4444;
      color:white;
    }

    .map-placeholder {
      background:rgba(255,255,255,0.03);
      border:1px dashed rgba(220,38,38,0.4);
      border-radius:20px;
      padding:3rem;
      text-align:center;
      color:#94a3b8;
      backdrop-filter: blur(2px);
    }

  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div>
      <div class="logo">Crimson<span>Shield</span></div>
      <div class="nav">
        <button onclick="goDashboard()">Dashboard</button>
        <button onclick="goAddDonor()">Add Donor</button>
        <button onclick="goFindBlood()">Find Blood</button>
        <button onclick="goTrackDonor()">Track Donor</button>
        <button onclick="goAnalytics()">Analytics</button>
        <button onclick="goProfile()">Profile</button>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <div class="header">
      <h1>
        Live Ambulance Tracking
        <!-- Animation placed right beside the heading -->
        <span class="header-animation">
          <span class='pin'></span>
          <span class='pulse'></span>
        </span>
      </h1>
    </div>

    <!-- STATUS -->
    <div class="status-card">
      <div class="status-title">Current Status: <span class="status-live">On The Way</span></div>
      <p>Distance Remaining: <strong id="distance">10 km</strong></p>
      <p>Estimated Arrival: <strong id="eta">15 mins</strong></p>

      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <!-- DRIVER INFO -->
    <div class="driver-card">
      <h3>Driver Details</h3>
      <p>Name: Arjun Mehta</p>
      <p>Vehicle No: KA-09-AB-1234</p>
      <p>Contact: +91 98765 43210</p>
      <button class="btn btn-call" onclick="callDriver()">ðŸ“ž Call Driver</button>
      <button class="btn btn-cancel" onclick="cancelRide()">Cancel Request</button>
    </div>

    <!-- MAP PLACEHOLDER -->
    
    <div class="map-placeholder">
      <div id="map" style="height: 600px; width: 100%; border-radius: 10px;"></div>
    </div>

  </div>

  <script>
    function goDashboard(){
      window.location.href="admin-dashboard.html";
    }
    
    function goAddDonor(){
      window.location.href="add-eligible-donor.html";
    }
    
    function goFindBlood(){
      window.location.href="contact-network.html";
    }
    
    function goTrackDonor(){
      window.location.href="ambulance-tracking.html";
    }
    function goAnalytics(){
      window.location.href="analytics.html";
    }
    function goProfile(){
      window.location.href="admin-profile.html";
    }
    
    function logout(){
      window.location.href="index.html";
    }

    let distance = 10;
    let eta = 15;
    let progress = 0;

    function simulateTracking() {
      if (distance > 0) {
        distance -= 1;
        eta -= 1;
        progress += 10;

        document.getElementById("distance").innerText = distance + " km";
        document.getElementById("eta").innerText = eta + " mins";
        document.getElementById("progressBar").style.width = progress + "%";
      }
    }

    setInterval(simulateTracking, 2000);

    function cancelRide() {
      alert("Ambulance request cancelled!");
    }

    function callDriver() {
      alert("Calling driver Arjun Mehta... (simulated)");
    }
  </script>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://lkflnzxcbwlmxounerex.supabase.co";
const supabaseKey = "sb_publishable_SqucPk5SOnBhLL6goXwxIQ_jDVlIy3x";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Initialize map (default Bangalore)
const map = L.map('map').setView([12.9716, 77.5946], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let markers = [];

async function loadDonors() {

    const { data, error } = await supabaseClient
        .from("donors")
        .select("*")
        .eq("is_available", true);

    if (error) {
        console.log("Error:", error);
        return;
    }

    // Remove old markers
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    data.forEach(donor => {
        if (donor.latitude && donor.longitude) {

            const marker = L.marker([donor.latitude, donor.longitude])
                .addTo(map)
                .bindPopup(`
                    <strong>${donor.name}</strong><br>
                    Blood Group: ${donor.blood_group}<br>
                    Phone: ${donor.phone}
                `);

            markers.push(marker);
        }
    });

    console.log("Loaded donors:", data.length);
}

// Load initially
loadDonors();

// Refresh every 10 seconds
setInterval(loadDonors, 10000);

</script>
<script>

let exactMap = L.map('exactMap').setView([12.9716, 77.5946], 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(exactMap);

let exactMarker;

async function loadExactLocation() {

    const { data, error } = await supabaseClient
        .from("donors")
        .select("*")
        .eq("is_available", true)
        .limit(1);   // Show one donor for demo

    if (error || !data.length) return;

    const donor = data[0];

    if (donor.latitude && donor.longitude) {

        const latLng = [donor.latitude, donor.longitude];

        exactMap.setView(latLng, 16);

        if (exactMarker) {
            exactMarker.setLatLng(latLng);
        } else {
            exactMarker = L.marker(latLng).addTo(exactMap)
                .bindPopup(`<b>${donor.name}</b><br>Blood: ${donor.blood_group}`)
                .openPopup();
        }
    }
}

loadExactLocation();
setInterval(loadExactLocation, 10000);

</script>
</body>
</html>